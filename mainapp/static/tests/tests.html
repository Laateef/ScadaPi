<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content"width=device-width">
	<title>Javascript Tests</title>
	<link rel="stylesheet" href="qunit-2.9.2.css">
</head>

<body>
	<div id="qunit"></div>
	<div id="qunit-fixture">
		<input name="csrfmiddlewaretoken" value="0123456789">

		<button id="main-switch" data-active="0">Start</button>

		<span id="t1" class="thermistor">Thermistor 1</span>
		<span id="t2" class="thermistor">Thermistor 2</span>
		<span id="t3" class="thermistor">Thermistor 3</span>
		<span id="t4" class="thermistor">Thermistor 4</span>
		<span id="t5" class="thermistor">Thermistor 5</span>
		<span id="t6" class="thermistor">Thermistor 6</span>
		<span id="t7" class="thermistor">Thermistor 7</span>
		<span id="t8" class="thermistor">Thermistor 8</span>
		<button id="v1" class="valve" data-active="1">Valve 1</button>
		<button id="v2" class="valve" data-active="0">Valve 2</button>
		<button id="v3" class="valve" data-active="0">Valve 3</button>
		<button id="v4" class="valve" data-active="0">Valve 4</button>
		<button id="v5" class="valve" data-active="0">Valve 5</button>
		<button id="p1" class="pump" data-active="1">Pump 1</button>
		<button id="p2" class="pump" data-active="0">Pump 2</button>
		<button id="p3" class="pump" data-active="0">Pump 3</button>
		<button id="h1" class="heater" data-active="1">Heater 1</button>
		<button id="h2" class="heater" data-active="1">Heater 2</button>

		<canvas id="temperature-chart"></canvas>
		<div id="experiment-view">
			<a class="experiment-link">
				<span class="experiment-id">2</span>
				<span class="decorative-arrow">&gt;</span>
				<span class="experiment-date">2019-11-17 09:55:61</span>
			</a>
			<a class="experiment-link">
				<span class="experiment-id">1</span>
				<span class="decorative-arrow">&gt;</span>
				<span class="experiment-date">2019-05-12 13:52:01</span>
			</a>
		</div>
	</div>

	<script src="../js/jquery-3.4.1.min.js"></script>
	<script src="../js/Chart.bundle.min.js"></script>
	<script src="../js/ctrl.js"></script>	
	<script src="../js/plot.js"></script>
	<script src="qunit-2.9.2.js"></script>
	<script src="sinon-7.4.1.js"></script>

	<script>
		var server;

		QUnit.testStart(function(){ server = sinon.fakeServer.create(); });

		QUnit.testDone(function(){ server.restore(); });

		QUnit.test("get device no from device element's id", function(assert){
			assert.equal(ctrl.get_device_no(document.getElementById('t8')), 8);
		});

		QUnit.test("get device type from device element's id", function(assert){
			assert.equal(ctrl.get_device_type(document.getElementById('h1')), 'heater');
			assert.equal(ctrl.get_device_type(document.getElementById('v5')), 'valve');
			assert.equal(ctrl.get_device_type(document.getElementById('p3')), 'pump');
			assert.equal(ctrl.get_device_type(document.getElementById('t8')), 'thermistor');
		});

		QUnit.test("populate thermistor boxes with temperature values by ajax", function(assert){
			var responseData = [
				{'id': 1, 'temperature': 25.1},
				{'id': 2, 'temperature': 26.2},
				{'id': 3, 'temperature': 27.3},
				{'id': 4, 'temperature': 28.4},
				{'id': 5, 'temperature': 29.5},
				{'id': 6, 'temperature': 30.6},
				{'id': 7, 'temperature': 31.7},  
				{'id': 8, 'temperature': 32.8}
			];
			server.respondWith('GET', '/api/thermistor/', [200, {"content-type": "application/json"}, JSON.stringify(responseData)]);
			
			ctrl.populate_thermistor_array();

			server.respond();
			
			for(var i = 1; i <= responseData.length; ++i)
				assert.equal(document.getElementById('t' + i).innerHTML, responseData[i - 1].temperature);
		});

		QUnit.test("fetch and set heater device state by ajax", function(assert){
			var responseData = [
				{'id': 1, 'state': 1},
				{'id': 2, 'state': 0}
			];
			server.respondWith('GET', '/api/heater/', [200, {"content-type": "application/json"}, JSON.stringify(responseData)]);
			
			ctrl.populate_heater_array();

			server.respond();
			
			for(var i = 1; i <= responseData.length; ++i)
				assert.equal(document.getElementById('h' + i).getAttribute('data-active'), responseData[i - 1].state);
		});

		QUnit.test("fetch and set pump device state by ajax", function(assert){
			var responseData = [
				{'id': 1, 'state': 1}, 
				{'id': 2, 'state': 1}, 
				{'id': 3, 'state': 0}
			];
			server.respondWith('GET', '/api/pump/', [200, {"content-type": "application/json"}, JSON.stringify(responseData)]);
			
			ctrl.populate_pump_array();

			server.respond();
			
			for(var i = 1; i <= responseData.length; ++i)
				assert.equal(document.getElementById('p' + i).getAttribute('data-active'), responseData[i - 1].state);
		});

		QUnit.test("fetch and set valve device state by ajax", function(assert){
			var responseData = [
				{'id': 1, 'state': 1}, 
				{'id': 2, 'state': 1}, 
				{'id': 3, 'state': 0}, 
				{'id': 4, 'state': 1}, 
				{'id': 5, 'state': 1}
			];
			server.respondWith('GET', '/api/valve/', [200, {"content-type": "application/json"}, JSON.stringify(responseData)]);
			
			ctrl.populate_valve_array();

			server.respond();
			
			for(var i = 1; i <= responseData.length; ++i)
				assert.equal(document.getElementById('v' + i).getAttribute('data-active'), responseData[i - 1].state);
		});

		QUnit.test("toggle heater device state by ajax", function(assert){
			ctrl.toggle_device(document.getElementById('h1'));

			assert.equal(server.requests.length, 1);
			assert.equal(server.requests[0].url, '/api/heater/1/toggle/');
			assert.equal(server.requests[0].method, 'POST');
		});

		QUnit.test("toggle pump device state by ajax", function(assert){
			ctrl.toggle_device(document.getElementById('p3'));

			assert.equal(server.requests.length, 1);
			assert.equal(server.requests[0].url, '/api/pump/3/toggle/');
			assert.equal(server.requests[0].method, 'POST');
		});

		QUnit.test("toggle valve device state by ajax", function(assert){
			ctrl.toggle_device(document.getElementById('v5'));

			assert.equal(server.requests.length, 1);
			assert.equal(server.requests[0].url, '/api/valve/5/toggle/');
			assert.equal(server.requests[0].method, 'POST');
		});

		QUnit.test("toggle automation by ajax", function(assert){
			ctrl.toggle_automation();

			assert.equal(server.requests.length, 1);
			assert.equal(server.requests[0].url, '/api/automation/toggle/');
			assert.equal(server.requests[0].method, 'POST');
		});

		QUnit.test("adjust main switch by ajax", function(assert){
			startStopButton = document.getElementById('main-switch')
			assert.equal(startStopButton.getAttribute('data-active'), '0')

			var responseData = [{'state': 1}];

			server.respondWith('GET', '/api/automation/', [200, {"content-type": "application/json"}, JSON.stringify(responseData)]);
			
			ctrl.adjust_main_switch();

			server.respond();

			assert.equal(startStopButton.getAttribute('data-active'), '1')

			responseData = [{'state': 0}];

			server.respondWith('GET', '/api/automation/', [200, {"content-type": "application/json"}, JSON.stringify(responseData)]);

			ctrl.adjust_main_switch();

			server.respond();

			assert.equal(startStopButton.getAttribute('data-active'), '0')
		});

		QUnit.test("select an experiment", function(assert){
			var experiment_link_list = document.getElementById('experiment-view').children;

			assert.equal(experiment_link_list[0].getAttribute('class'), 'experiment-link');
			assert.equal(experiment_link_list[1].getAttribute('class'), 'experiment-link');

			plot.select_experiment(experiment_link_list[0]);

			assert.equal(experiment_link_list[0].getAttribute('class'), 'experiment-link active');
			assert.equal(experiment_link_list[1].getAttribute('class'), 'experiment-link');

			plot.select_experiment(experiment_link_list[1]);

			assert.equal(experiment_link_list[0].getAttribute('class'), 'experiment-link');
			assert.equal(experiment_link_list[1].getAttribute('class'), 'experiment-link active');
		});

		QUnit.test("when no experiment is selected (or exists), update_temperature does nothing", function(assert){
			$('.experiment-link').removeClass('active');
			
			plot.init();

			plot.update_temperature();

			assert.equal(server.requests.length, 0);
		});

		QUnit.test("fetch experiment data from server by ajax", function(assert){
			$('#experiment-view').empty();

			var experiment_view = document.getElementById('experiment-view');

			plot.init();

			var responseData = [
				{'id': 1, 'start_date': '2019-08-02 13:06:32', 'end_date': '2019-08-02 13:06:32'},
				{'id': 2, 'start_date': '2019-08-03 14:06:32', 'end_date': '2019-08-03 15:16:38'}
			];
			
			server.respondWith('GET', '/api/experiment/', [200, {"content-type": "application/json"}, JSON.stringify(responseData)]);

			plot.update_experiment();

			server.respond();

			assert.equal(server.requests.length, 1);
			assert.equal(server.requests[0].url, '/api/experiment/');
			assert.equal(server.requests[0].method, 'GET');

			assert.equal(experiment_view.childElementCount, 2);

			// because experiment_view lists the items in reverse, last inserted item is at the top
			var first_anchor_element = experiment_view.children[1];
			assert.equal(first_anchor_element.getAttribute('class'), 'experiment-link');
			assert.equal(first_anchor_element.getAttribute('onclick'), 'plot.select_experiment(this)');
			assert.equal(first_anchor_element.children[0].getAttribute('class'), 'experiment-id');
			assert.equal(first_anchor_element.children[0].innerHTML, 1);
			assert.equal(first_anchor_element.children[1].getAttribute('class'), 'decorative-arrow');
			assert.equal(first_anchor_element.children[1].innerHTML, '&gt;'); // escaped character of >
			assert.equal(first_anchor_element.children[2].getAttribute('class'), 'experiment-date');
			assert.equal(first_anchor_element.children[2].innerHTML, '2019-08-02 13:06:32');

			responseData = [{'id': 3, 'start_date': '2019-08-04 15:06:32', 'end_date': '2019-08-04 16:32:40'}];

			server.respondWith('GET', '/api/experiment/?last=2', [200, {"content-type": "application/json"}, JSON.stringify(responseData)]);

			plot.update_experiment();

			server.respond();

			assert.equal(server.requests.length, 2);
			assert.equal(server.requests[1].url, '/api/experiment/?last=2');
			assert.equal(server.requests[1].method, 'GET');

			assert.equal(experiment_view.childElementCount, 3);
			assert.equal(experiment_view.children[0].children[0].innerHTML, 3);
		});

		QUnit.test("fetch temperature data from server by ajax", function(assert){
			// selecting an element is mandatory for plot.update_temperature() to work.
			plot.select_experiment(document.getElementById('experiment-view').firstElementChild);

			plot.init();

			var responseData = [
				{'id': 1, 'experiment': 2, 'date': '2019-08-02 13:06:32', 'temperature_array': [28.5, 29.9, 31.4, 32.2, 22.5, 48.7, 68.1, 66.8]},
				{'id': 2, 'experiment': 2, 'date': '2019-08-02 13:09:21', 'temperature_array': [29.6, 30.0, 32.5, 33.3, 23.6, 49.8, 69.2, 67.9]}
			];
			
			server.respondWith('GET', '/api/temperature/?experiment=2', [200, {"content-type": "application/json"}, JSON.stringify(responseData)]);

			plot.update_temperature();

			server.respond();

			assert.equal(server.requests.length, 1);
			assert.equal(server.requests[0].url, '/api/temperature/?experiment=2');
			assert.equal(server.requests[0].method, 'GET');

			assert.equal(plot.chart_config.data.labels.length, 2);
			assert.equal(plot.chart_config.data.labels[plot.chart_config.data.labels.length - 1], responseData[1].date)

			plot.chart_config.data.datasets.forEach(function(dataset, index){
				assert.equal(dataset.data[dataset.data.length - 1], responseData[1].temperature_array[index]);
			});

			responseData = [{ 'id': 3, 'experiment': 2, 'date': '2019-08-02 13:12:02', 'temperature_array': [30.7, 31.1, 33.6, 34.4, 24.7, 50.9, 70.3, 69.0] }];

			server.respondWith('GET', '/api/temperature/?experiment=2&last_date=2019-08-02 13:09:21', [200, {"content-type": "application/json"}, JSON.stringify(responseData)]);

			plot.update_temperature();

			server.respond();

			assert.equal(server.requests.length, 2);
			assert.equal(server.requests[1].url, '/api/temperature/?experiment=2&last_date=2019-08-02 13:09:21');
			assert.equal(server.requests[1].method, 'GET');

			assert.equal(plot.chart_config.data.labels.length, 3);
			assert.equal(plot.chart_config.data.labels[plot.chart_config.data.labels.length - 1], responseData[0].date)

			plot.chart_config.data.datasets.forEach(function(dataset, index){
				assert.equal(dataset.data[dataset.data.length - 1], responseData[0].temperature_array[index]);
			});
		});

	</script>

</body>
</html>
