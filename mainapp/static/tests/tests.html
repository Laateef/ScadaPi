<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content"width=device-width">
	<title>Javascript Tests</title>
	<link rel="stylesheet" href="qunit-2.9.2.css">
</head>

<body>
	<div id="qunit"></div>
	<div id="qunit-fixture">
		<button id="main_switch">Start</button>

		<span id="t1" class="thermistor">Thermistor 1</span>
		<span id="t2" class="thermistor">Thermistor 2</span>
		<span id="t3" class="thermistor">Thermistor 3</span>
		<span id="t4" class="thermistor">Thermistor 4</span>
		<span id="t5" class="thermistor">Thermistor 5</span>
		<span id="t6" class="thermistor">Thermistor 6</span>
		<span id="t7" class="thermistor">Thermistor 7</span>
		<span id="t8" class="thermistor">Thermistor 8</span>
		<button id="v1" class="valve">Valve 1</button>
		<button id="v2" class="valve">Valve 2</button>
		<button id="v3" class="valve">Valve 3</button>
		<button id="v4" class="valve">Valve 4</button>
		<button id="v5" class="valve">Valve 5</button>
		<button id="p1" class="pump">Pump 1</button>
		<button id="p2" class="pump">Pump 2</button>
		<button id="p3" class="pump">Pump 3</button>
		<button id="h1" class="heater">Heater 1</button>
		<button id="h2" class="heater">Heater 2</button>
	</div>

	<script src="../js/jquery-3.4.1.min.js"></script>
	<script src="../js/base.js"></script>
	<script src="qunit-2.9.2.js"></script>
	<script src="sinon-7.4.1.js"></script>

	<script>
		var server;

		QUnit.testStart(function(){ server = sinon.fakeServer.create(); });

		QUnit.testDone(function(){ server.restore(); });

		QUnit.test("get device no from device element's id", function(assert){
			assert.equal(base.get_device_no(document.getElementById('t8')), 8);
		});

		QUnit.test("get device type from device element's id", function(assert){
			assert.equal(base.get_device_type(document.getElementById('h1')), 'heater');
			assert.equal(base.get_device_type(document.getElementById('v5')), 'valve');
			assert.equal(base.get_device_type(document.getElementById('p3')), 'pump');
			assert.equal(base.get_device_type(document.getElementById('t8')), 'thermistor');
		});

		QUnit.test("populate thermistor boxes with temperature values by ajax", function(assert){
			var responseData = [
				{'id': 1, 'temperature': 25.1},
				{'id': 2, 'temperature': 26.2},
				{'id': 3, 'temperature': 27.3},
				{'id': 4, 'temperature': 28.4},
				{'id': 5, 'temperature': 29.5},
				{'id': 6, 'temperature': 30.6},
				{'id': 7, 'temperature': 31.7},  
				{'id': 8, 'temperature': 32.8}
			];
			server.respondWith('GET', '/api/thermistor/', [200, {"content-type": "application/json"}, JSON.stringify(responseData)]);
			
			base.populate_thermistor_array();

			server.respond();
			
			for(var i = 1; i <= responseData.length; ++i)
				assert.equal(document.getElementById('t' + i).innerHTML, responseData[i - 1].temperature);
		});

		QUnit.test("fetch and set heater device state by ajax", function(assert){
			var responseData = [
				{'id': 1, 'state': 1},
				{'id': 2, 'state': 0}
			];
			server.respondWith('GET', '/api/heater/', [200, {"content-type": "application/json"}, JSON.stringify(responseData)]);
			
			base.populate_heater_array();

			server.respond();
			
			for(var i = 1; i <= responseData.length; ++i)
				assert.equal(document.getElementById('h' + i).innerHTML, responseData[i - 1].state);
		});

		QUnit.test("fetch and set pump device state by ajax", function(assert){
			var responseData = [
				{'id': 1, 'state': 1}, 
				{'id': 2, 'state': 1}, 
				{'id': 3, 'state': 0}
			];
			server.respondWith('GET', '/api/pump/', [200, {"content-type": "application/json"}, JSON.stringify(responseData)]);
			
			base.populate_pump_array();

			server.respond();
			
			for(var i = 1; i <= responseData.length; ++i)
				assert.equal(document.getElementById('p' + i).innerHTML, responseData[i - 1].state);
		});

		QUnit.test("fetch and set valve device state by ajax", function(assert){
			var responseData = [
				{'id': 1, 'state': 1}, 
				{'id': 2, 'state': 1}, 
				{'id': 3, 'state': 0}, 
				{'id': 4, 'state': 1}, 
				{'id': 5, 'state': 1}
			];
			server.respondWith('GET', '/api/valve/', [200, {"content-type": "application/json"}, JSON.stringify(responseData)]);
			
			base.populate_valve_array();

			server.respond();
			
			for(var i = 1; i <= responseData.length; ++i)
				assert.equal(document.getElementById('v' + i).innerHTML, responseData[i - 1].state);
		});

		QUnit.test("toggle heater device state by ajax", function(assert){
			base.toggle_device(document.getElementById('h1'));

			assert.equal(server.requests.length, 1);
			assert.equal(server.requests[0].url, '/api/heater/1/toggle/');
			assert.equal(server.requests[0].method, 'PATCH');
		});

		QUnit.test("toggle pump device state by ajax", function(assert){
			base.toggle_device(document.getElementById('p3'));

			assert.equal(server.requests.length, 1);
			assert.equal(server.requests[0].url, '/api/pump/3/toggle/');
			assert.equal(server.requests[0].method, 'PATCH');
		});

		QUnit.test("toggle valve device state by ajax", function(assert){
			base.toggle_device(document.getElementById('v5'));

			assert.equal(server.requests.length, 1);
			assert.equal(server.requests[0].url, '/api/valve/5/toggle/');
			assert.equal(server.requests[0].method, 'PATCH');
		});

		QUnit.test("toggle automation by ajax", function(assert){
			base.toggle_automation();

			assert.equal(server.requests.length, 1);
			assert.equal(server.requests[0].url, '/api/automation/toggle/');
			assert.equal(server.requests[0].method, 'PATCH');
		});

		QUnit.test("adjust main switch by ajax", function(assert){
			startStopButton = document.getElementById('main_switch')
			assert.equal(startStopButton.innerHTML, "Start")

			var responseData = [{'state': 1}];

			server.respondWith('GET', '/api/automation/', [200, {"content-type": "application/json"}, JSON.stringify(responseData)]);
			
			base.adjust_main_switch();

			server.respond();

			assert.equal(startStopButton.innerHTML, "Stop")

			responseData = [{'state': 0}];

			server.respondWith('GET', '/api/automation/', [200, {"content-type": "application/json"}, JSON.stringify(responseData)]);

			base.adjust_main_switch();

			server.respond();

			assert.equal(startStopButton.innerHTML, "Start")
		});
	</script>

</body>
</html>
